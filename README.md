# Medic OS: Simplest Possible Package

This package contains a simple, self-contained "Hello, world!"
package and package build script for Medic OS. The package should
install cleanly to Medic OS installations, and print/log various
strings in various places to demonstrate features of the packaging
system.

This package is architecture-independent, and should be able to be
built and/or used on any supported system, regardless of CPU or
software/hardware architecture.

## Trying It Out

### Building

This build process requires a working `make` (BSD or GNU) and `shasum`.

A copy of GNU `ar` is required. On most systems, this will be contained
in the `binutils` package. On Mac OS X, the default system `ar` will not
work; consider installing `binutils` from [Homebrew](http://brew.sh) and
adding `/Utilities/Homebrew/Cellar/binutils/*/*/bin` to your `$PATH`.

To build the package:

```shell
$ make
```

Output will be placed in `output/packages`:

```shell
$ ls -al output/packages
total 8.0K
-rw-r--r-- 1 user group 1.8K Feb 13 04:30 simplest-possible-v10000-x64.vpkg
```

### Installing

To install the package, `scp` or `rsync` the package to an existing Medic OS
instance:

```shell
$ rsync -vaPe ssh output/packages/simplest-possible-*.vpkg user@host.local:~/
```

Then, on the Medic OS system, run:

```shell
$ sudo package-install simplest-possible-*.vpkg
```

You should see output similar to the following:

```
Info: Installing package 'simplest-possible-v10000-x64.vpkg'...
Hello, software installation!
I have version 1.0.0; hope that's right.
Info: Running setup task 'simplest-possible/hello'
Hello, configuration data!
Hello, setup script!
Info: Service 'simplest-possible/hello' started successfully
Info: Package 'simplest-possible' was successfully installed
Success: All specified packages are installed
```

The second and third lines of the above output are generated by the package's
[installation script](https://github.com/medic/medic-os-simplest-possible-package/blob/master/packages/simplest-possible/scripts/simplest-possible/install).

The fifth and sixth lines of the above output are generated by one of the package's
[setup scripts](https://github.com/medic/medic-os-simplest-possible-package/blob/master/packages/simplest-possible/scripts/simplest-possible/setup/hello),
employing information defined in the package's
[`env` file](https://github.com/medic/medic-os-simplest-possible-package/blob/master/packages/simplest-possible/scripts/simplest-possible/env).


### Updating

To simulate a package update, open the `Makefile` in your favorite text
editor and increment the package version number (e.g. change `10000` to
`10001` or higher). Rebuild and re-transfer the package as described in
the [Installing](#installing) section above.

Then, on the Medic OS system, run:

```shell
$ sudo package-update simplest-possible-*.vpkg
```

### Removing

To remove the package, run the following command on the Medic OS
system:

```shell
$ sudo package-remove simplest-possible
```

You'll see output similar to the following:

```
Info: Removing package 'simplest-possible'...
Info: Service 'simplest-possible/hello' stopped successfully
Hello, software removal!
I'm removing version 1.0.0.
Info: Package 'simplest-possible' successfully removed
Success: All specified packages have been removed
```

The third and fourth lines of the above output are generated by the package's
[removal script](https://github.com/medic/medic-os-simplest-possible-package/blob/master/packages/simplest-possible/scripts/simplest-possible/remove),
employing information defined in the package's
[`env` file](https://github.com/medic/medic-os-simplest-possible-package/blob/master/packages/simplest-possible/scripts/simplest-possible/env).

Note that it's not necessary to explicitly remove files included with a
package's `tar` archive; these are automatically added to the package's
`manifest` and automatically deleted after the `remove` script finishes.

If you run `sudo supervisor-inspect` after removing the package, you'll
notice that it's missing from the list. Services always belong to a package,
and services are always automatically stopped prior to package removal.


### Installation Artifacts

After installation, running `sudo supervisor-inspect` will show you
information about a new service:

```
Package 'simplest-possible':
  Service 'hello':
    Status: Up
    Up: 451 seconds, Restarts: 0
    Attributes: watched, running, expected
    Service PID: 1759, Supervisor PID: 1741
```

You'll also see new files beneath `/srv/system`; these record information
about what version of the package was used, and where it placed files:

```
$ ls -al /srv/system/storage/receipts/simplest-possible
-rw-r--r--    1 root     root           764 Jun 27 17:26 manifest
-rw-r--r--    1 root     root             5 Jun 27 17:26 version
```

These are maintained automatically by the packaging system and do
not require any explicit action from a package installation or setup
script.

## Gory Details

Some basic introductory documentation on the package format, including
information on directory structure conventions and required scripts, is
available in the Medic OS [repository](https://github.com/medic/medic-os)
at [PACKAGES.md](https://github.com/medic/medic-os/blob/master/PACKAGES.md).
